#!/bin/bash

echo "üîß ZYRO Marketplace - SIMULADOR iOS RECREADO DESDE CERO"
echo "======================================================="

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}üöÄ RECREANDO simulador iOS con TODAS las funcionalidades implementadas...${NC}"
echo -e "${CYAN}üìã Basado en todas las sesiones abiertas y requirements completos${NC}"

# 1. VERIFICACI√ìN COMPLETA DEL ENTORNO
echo -e "${YELLOW}1. üîç VERIFICACI√ìN COMPLETA DEL ENTORNO DE DESARROLLO...${NC}"

# Verificar Xcode
xcode-select --print-path > /dev/null 2>&1
if [ $? -eq 0 ]; then
    XCODE_VERSION=$(xcodebuild -version | head -1)
    echo -e "${GREEN}‚úÖ $XCODE_VERSION${NC}"
    
    # Mostrar simuladores disponibles
    echo -e "${BLUE}üì± Simuladores iOS disponibles:${NC}"
    xcrun simctl list devicetypes | grep iPhone | head -5
else
    echo -e "${RED}‚ùå Xcode no encontrado. Instala Xcode desde App Store${NC}"
    exit 1
fi

# Verificar Node.js y npm
NODE_VERSION=$(node --version 2>/dev/null || echo "No instalado")
NPM_VERSION=$(npm --version 2>/dev/null || echo "No instalado")
EXPO_VERSION=$(npx expo --version 2>/dev/null || echo "No instalado")

echo -e "${BLUE}üü¢ Node.js: $NODE_VERSION${NC}"
echo -e "${BLUE}üì¶ npm: $NPM_VERSION${NC}"
echo -e "${BLUE}‚ö° Expo CLI: $EXPO_VERSION${NC}"

# 2. LIMPIEZA PROFUNDA Y RECREACI√ìN
echo -e "${YELLOW}2. üßπ LIMPIEZA PROFUNDA Y RECREACI√ìN DEL ENTORNO...${NC}"

# Detener todos los procesos relacionados
echo -e "${BLUE}üõë Deteniendo procesos activos...${NC}"
pkill -f "Metro" > /dev/null 2>&1 || true
pkill -f "expo" > /dev/null 2>&1 || true
pkill -f "react-native" > /dev/null 2>&1 || true
pkill -f "node.*start" > /dev/null 2>&1 || true

# Limpieza completa de cache
echo -e "${BLUE}üóëÔ∏è  Limpiando cache completo...${NC}"
rm -rf .expo
rm -rf .metro-cache
rm -rf node_modules/.cache
rm -rf /tmp/metro-*
rm -rf /tmp/react-*
rm -rf /tmp/haste-*
rm -rf /tmp/expo-*
npm cache clean --force > /dev/null 2>&1

# Limpiar simuladores iOS
echo -e "${BLUE}üì± Reseteando simuladores iOS...${NC}"
xcrun simctl shutdown all > /dev/null 2>&1 || true
xcrun simctl erase all > /dev/null 2>&1 || true

# 3. CONFIGURACI√ìN AVANZADA DE VARIABLES DE ENTORNO
echo -e "${YELLOW}3. ‚öôÔ∏è  CONFIGURACI√ìN AVANZADA DE VARIABLES DE ENTORNO...${NC}"

# Variables optimizadas para iOS Simulator
export EXPO_NO_FLIPPER=1
export RCT_NO_LAUNCH_PACKAGER=1
export SKIP_BUNDLING=0
export EXPO_USE_FAST_RESOLVER=1
export EXPO_USE_METRO_WORKSPACE_ROOT=1
export EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
export NODE_OPTIONS="--max-old-space-size=8192"
export REACT_NATIVE_PACKAGER_HOSTNAME="localhost"
export EXPO_CLI_NO_DOCTOR=1

# Variables espec√≠ficas para ZYRO Marketplace
export ZYRO_ENV="ios_simulator"
export ZYRO_DEBUG_MODE=1
export ZYRO_ENHANCED_LOGGING=1

echo -e "${GREEN}‚úÖ Variables de entorno configuradas para m√°ximo rendimiento${NC}"

# 4. CONFIGURACI√ìN AVANZADA DEL SIMULADOR iOS
echo -e "${YELLOW}4. üì± CONFIGURACI√ìN AVANZADA DEL SIMULADOR iOS...${NC}"

# Buscar el mejor simulador disponible
LATEST_IOS=$(xcrun simctl list runtimes | grep iOS | tail -1 | awk '{print $2}' | sed 's/[()]//g')
PREFERRED_DEVICES=("iPhone 15 Pro Max" "iPhone 15 Pro" "iPhone 15" "iPhone 14 Pro")

echo -e "${BLUE}üéØ iOS Runtime disponible: $LATEST_IOS${NC}"

# Buscar el mejor dispositivo disponible
SELECTED_DEVICE=""
DEVICE_ID=""

for device in "${PREFERRED_DEVICES[@]}"; do
    DEVICE_ID=$(xcrun simctl list devices | grep "$device" | grep -v "unavailable" | head -1 | grep -o '[A-F0-9-]\{36\}')
    if [ ! -z "$DEVICE_ID" ]; then
        SELECTED_DEVICE="$device"
        break
    fi
done

if [ -z "$DEVICE_ID" ]; then
    # Crear simulador ZYRO optimizado
    echo -e "${BLUE}üîß Creando simulador ZYRO optimizado...${NC}"
    DEVICE_ID=$(xcrun simctl create "ZYRO-iOS-Enhanced" "com.apple.CoreSimulator.SimDeviceType.iPhone-15-Pro" "com.apple.CoreSimulator.SimRuntime.iOS-17-5" 2>/dev/null || echo "")
    SELECTED_DEVICE="iPhone 15 Pro (ZYRO Enhanced)"
fi

echo -e "${GREEN}‚úÖ Simulador seleccionado: $SELECTED_DEVICE${NC}"
echo -e "${GREEN}‚úÖ Device ID: $DEVICE_ID${NC}"

# 5. VERIFICACI√ìN Y OPTIMIZACI√ìN DE DEPENDENCIAS
echo -e "${YELLOW}5. üì¶ VERIFICACI√ìN Y OPTIMIZACI√ìN DE DEPENDENCIAS...${NC}"

# Verificar package.json
if [ ! -f "package.json" ]; then
    echo -e "${RED}‚ùå package.json no encontrado${NC}"
    exit 1
fi

# Verificar dependencias cr√≠ticas
echo -e "${BLUE}üîç Verificando dependencias cr√≠ticas...${NC}"
CRITICAL_DEPS=(
    "expo"
    "react-native"
    "@expo/metro-runtime"
    "react"
    "react-redux"
    "@reduxjs/toolkit"
    "expo-linear-gradient"
    "react-native-maps"
)

MISSING_DEPS=()
for dep in "${CRITICAL_DEPS[@]}"; do
    if [ -d "node_modules/$dep" ]; then
        VERSION=$(node -p "require('./node_modules/$dep/package.json').version" 2>/dev/null || echo "unknown")
        echo -e "${GREEN}‚úÖ $dep ($VERSION)${NC}"
    else
        echo -e "${RED}‚ùå $dep faltante${NC}"
        MISSING_DEPS+=("$dep")
    fi
done

# Instalar dependencias faltantes si es necesario
if [ ${#MISSING_DEPS[@]} -gt 0 ]; then
    echo -e "${YELLOW}üì¶ Instalando dependencias faltantes...${NC}"
    npm install --legacy-peer-deps
fi

# 6. VERIFICACI√ìN DE CONFIGURACI√ìN DE LA APP
echo -e "${YELLOW}6. üîß VERIFICACI√ìN DE CONFIGURACI√ìN DE LA APP...${NC}"

# Verificar app.json
if [ -f "app.json" ]; then
    echo -e "${GREEN}‚úÖ app.json encontrado${NC}"
    
    # Verificar configuraci√≥n iOS
    if grep -q "\"ios\":" app.json; then
        echo -e "${GREEN}‚úÖ Configuraci√≥n iOS presente${NC}"
        
        # Verificar bundle identifier
        if grep -q "com.zyro.marketplace" app.json; then
            echo -e "${GREEN}‚úÖ Bundle ID: com.zyro.marketplace${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Bundle ID no configurado correctamente${NC}"
        fi
    else
        echo -e "${RED}‚ùå Configuraci√≥n iOS faltante en app.json${NC}"
    fi
else
    echo -e "${RED}‚ùå app.json no encontrado${NC}"
fi

# Verificar metro.config.js
if [ -f "metro.config.js" ]; then
    echo -e "${GREEN}‚úÖ metro.config.js encontrado${NC}"
    
    if grep -q "resolver.platforms" metro.config.js; then
        echo -e "${GREEN}‚úÖ Metro config optimizado para iOS${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Metro config b√°sico detectado${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  metro.config.js no encontrado${NC}"
fi

# 7. VERIFICACI√ìN DE COMPONENTES PRINCIPALES
echo -e "${YELLOW}7. üß© VERIFICACI√ìN DE COMPONENTES PRINCIPALES...${NC}"

# Verificar componentes cr√≠ticos
MAIN_COMPONENTS=(
    "App.js"
    "components/ZyroAppNew.js"
    "store/index.js"
    "services/StorageService.js"
)

echo -e "${BLUE}üîç Verificando componentes principales...${NC}"
for component in "${MAIN_COMPONENTS[@]}"; do
    if [ -f "$component" ]; then
        # Verificar sintaxis JavaScript
        if node -c "$component" 2>/dev/null; then
            echo -e "${GREEN}‚úÖ $component - Sintaxis correcta${NC}"
        else
            echo -e "${RED}‚ùå $component - Error de sintaxis${NC}"
        fi
    else
        echo -e "${RED}‚ùå $component - Archivo faltante${NC}"
    fi
done

# Verificar assets cr√≠ticos
ASSETS=(
    "assets/logozyrotransparente.png"
)

echo -e "${BLUE}üñºÔ∏è  Verificando assets...${NC}"
for asset in "${ASSETS[@]}"; do
    if [ -f "$asset" ]; then
        echo -e "${GREEN}‚úÖ $asset${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  $asset (se crear√° placeholder si es necesario)${NC}"
    fi
done

# 8. INICIALIZACI√ìN DEL SIMULADOR iOS
echo -e "${YELLOW}8. üöÄ INICIALIZACI√ìN DEL SIMULADOR iOS...${NC}"

if [ ! -z "$DEVICE_ID" ]; then
    echo -e "${BLUE}üì± Iniciando simulador: $SELECTED_DEVICE${NC}"
    
    # Boot del simulador
    xcrun simctl boot "$DEVICE_ID" > /dev/null 2>&1 || true
    
    # Abrir Simulator app
    open -a Simulator --args -CurrentDeviceUDID "$DEVICE_ID"
    
    # Configurar simulador para desarrollo
    echo -e "${BLUE}‚öôÔ∏è  Configurando simulador para desarrollo...${NC}"
    
    # Configurar timezone
    xcrun simctl spawn "$DEVICE_ID" defaults write com.apple.preferences.datetime.plist AppleCurrentTimezone "Europe/Madrid" > /dev/null 2>&1 || true
    
    # Configurar idioma
    xcrun simctl spawn "$DEVICE_ID" defaults write NSGlobalDomain AppleLanguages -array "es-ES" > /dev/null 2>&1 || true
    
    sleep 5
else
    echo -e "${YELLOW}‚ö†Ô∏è  Abriendo simulador por defecto...${NC}"
    open -a Simulator
    sleep 3
fi

# 9. VERIFICACI√ìN FINAL DEL SIMULADOR
echo -e "${YELLOW}9. ‚úÖ VERIFICACI√ìN FINAL DEL SIMULADOR...${NC}"

# Verificar estado del simulador
RETRY_COUNT=0
MAX_RETRIES=10

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if xcrun simctl list devices | grep -q "Booted"; then
        BOOTED_DEVICE=$(xcrun simctl list devices | grep "Booted" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
        echo -e "${GREEN}‚úÖ Simulador iOS ejecut√°ndose correctamente${NC}"
        echo -e "${BLUE}üì± Dispositivo activo: $BOOTED_DEVICE${NC}"
        break
    else
        echo -e "${YELLOW}‚è≥ Esperando simulador... ($((RETRY_COUNT + 1))/$MAX_RETRIES)${NC}"
        sleep 2
        RETRY_COUNT=$((RETRY_COUNT + 1))
    fi
done

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Simulador tardando en iniciar, continuando...${NC}"
fi

# 10. Iniciar la aplicaci√≥n con configuraci√≥n optimizada
echo -e "${YELLOW}10. Iniciando ZYRO Marketplace...${NC}"
echo -e "${PURPLE}üöÄ Comando: npx expo start --ios --clear --dev-client${NC}"

# Configuraci√≥n final para desarrollo
export NODE_OPTIONS="--max-old-space-size=8192"
export EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0

# Iniciar con todas las optimizaciones
npx expo start --ios --clear --dev-client --localhost

echo -e "${GREEN}üéâ ZYRO Marketplace iniciado en simulador iOS${NC}"
echo -e "${BLUE}üí° Funcionalidades disponibles:${NC}"
echo -e "   ‚úÖ Navegaci√≥n completa (4 pesta√±as)"
echo -e "   ‚úÖ Mapa interactivo de Espa√±a"
echo -e "   ‚úÖ Sistema de colaboraciones"
echo -e "   ‚úÖ Panel de administraci√≥n"
echo -e "   ‚úÖ Notificaciones push"
echo -e "   ‚úÖ Gesti√≥n de perfil"

echo -e "${PURPLE}üîß Comandos √∫tiles:${NC}"
echo -e "   ‚Ä¢ Reload: Cmd+R en simulador"
echo -e "   ‚Ä¢ Debug menu: Cmd+D en simulador"
echo -e "   ‚Ä¢ Logs: npx expo logs --platform ios"
echo -e "   ‚Ä¢ Reset: ./reset-and-start.sh"# 10.
 INICIO DE ZYRO MARKETPLACE CON TODAS LAS FUNCIONALIDADES
echo -e "${YELLOW}10. üöÄ INICIANDO ZYRO MARKETPLACE CON TODAS LAS FUNCIONALIDADES...${NC}"

echo -e "${CYAN}üìã FUNCIONALIDADES IMPLEMENTADAS:${NC}"
echo -e "${GREEN}   ‚úÖ Sistema de autenticaci√≥n completo (admin_zyrovip)${NC}"
echo -e "${GREEN}   ‚úÖ Navegaci√≥n por 4 pesta√±as premium${NC}"
echo -e "${GREEN}   ‚úÖ Mapa interactivo de Espa√±a con 20+ ciudades${NC}"
echo -e "${GREEN}   ‚úÖ Sistema de colaboraciones con filtros avanzados${NC}"
echo -e "${GREEN}   ‚úÖ Panel de administraci√≥n completo${NC}"
echo -e "${GREEN}   ‚úÖ Notificaciones push configuradas${NC}"
echo -e "${GREEN}   ‚úÖ Redux Store con persistencia${NC}"
echo -e "${GREEN}   ‚úÖ Est√©tica premium dorada/negra${NC}"
echo -e "${GREEN}   ‚úÖ Logo logozyrotransparente.PNG implementado${NC}"
echo -e "${GREEN}   ‚úÖ Chat system integrado${NC}"
echo -e "${GREEN}   ‚úÖ Gesti√≥n completa de perfil${NC}"

echo -e "${PURPLE}üéØ CREDENCIALES DE PRUEBA:${NC}"
echo -e "${CYAN}   üëë Admin: admin_zyrovip / xarrec-2paqra-guftoN${NC}"
echo -e "${CYAN}   üë§ Influencer: cualquier email / cualquier contrase√±a${NC}"
echo -e "${CYAN}   üè¢ Empresa: cualquier email / cualquier contrase√±a${NC}"

echo -e "${PURPLE}üöÄ Iniciando con configuraci√≥n iOS optimizada...${NC}"

# Funci√≥n para manejar Ctrl+C
cleanup() {
    echo -e "\n${YELLOW}üõë Deteniendo ZYRO Marketplace...${NC}"
    pkill -f "expo start" > /dev/null 2>&1 || true
    pkill -f "Metro" > /dev/null 2>&1 || true
    echo -e "${GREEN}‚úÖ ZYRO Marketplace detenido correctamente${NC}"
    exit 0
}

trap cleanup INT

# Iniciar con todas las optimizaciones
echo -e "${BLUE}üî• Comando: npx expo start --ios --localhost --clear${NC}"
npx expo start --ios --localhost --clear

echo -e "${GREEN}üéâ ZYRO Marketplace completado${NC}"
echo -e "${PURPLE}üîß Comandos √∫tiles durante desarrollo:${NC}"
echo -e "   ‚Ä¢ Reload app: Cmd+R en simulador"
echo -e "   ‚Ä¢ Debug menu: Cmd+D en simulador"  
echo -e "   ‚Ä¢ Ver logs: npx expo logs --platform ios"
echo -e "   ‚Ä¢ Reset completo: ./reset-and-start.sh"
echo -e "   ‚Ä¢ Tests: ./test-ios-complete.sh"